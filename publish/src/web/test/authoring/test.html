<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
 <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
 <title>iseepublish Authoring Manager</title>
 <script type="text/javascript" src="src/dragresize.js"></script>
 <script type="text/javascript" src="src/http.js"></script>
 <script type="text/javascript" src="src/json2xml.js"></script>
 <script type="text/javascript" src="src/xml.js"></script>
 <script type="text/javascript" src="src/xml2json.js"></script>

<script type="text/javascript">
// var SERVER = "http://rziegler:8080/pdfeditor/";
var SERVER = "http://snafu.iseemedia.com/pdfeditor/";
// var DOCUMENT_ID = "ihtOnePage";
var DOCUMENT_ID = "businessweek_test";
var pageIndex = 0;
var pageObject;


function changeDocument(docId)
{
	deleteHotspots();
	pageObject.iseepagelayout.page.contentgroup = [];
	DOCUMENT_ID = docId;
	pageIndex = 0;
	initialize();
}

function changePage(page)
{
	deleteHotspots();
	pageObject.iseepagelayout.page.contentgroup = [];
	pageIndex = page;
	initialize();
}

function saveTable()
{
	var cg = pageObject.iseepagelayout.page.contentgroup;

	var t = document.getElementById("table1");
	// Iterate through table and store in data set
	for (var i = 0; i < cg.length+1; i++)
	{
		// If data row was deleted then skip
		if (cg[i] == null) continue;
		if (t.rows[i+1] == null) continue;

		// Set empty values in data set
		if (cg[i].text == null) cg[i].text = [];
		if (cg[i].figure == null) cg[i].figure = [];

		cg[i].titlestring = t.rows[i+1].cells[1].firstChild.value;
		cg[i].type = t.rows[i+1].cells[2].firstChild.value;

		var email = t.rows[i+1].cells[3].firstChild.value;
		if(typeof(email) == "string" && email != undefined) cg[i].email = email;

		var phone = t.rows[i+1].cells[4].firstChild.value;
		if(typeof(phone) == "string" && phone != undefined) cg[i].phone = phone;

		var sms = t.rows[i+1].cells[5].firstChild.value;
		if(typeof(sms) == "string" && sms != undefined) cg[i].sms = sms;

/*
		cg[i].email = t.rows[i+1].cells[3].firstChild.value;
		cg[i].phone = t.rows[i+1].cells[4].firstChild.value;
		cg[i].sms = t.rows[i+1].cells[5].firstChild.value;
*/
	}
}
function submit()
{
	var cg = pageObject.iseepagelayout.page.contentgroup;

	saveTable();
	// Set hotspot coordinates in data set
	for (var i = 0; i < cg.length; i++)
	{	
		// If data row was deleted then skip
		if (cg[i] == null) continue;

		var div = document.getElementById("hotspot" + i);
		var x1  = parseInt(div.style.left) / iimage.width;
		var y1 = parseInt(div.style.top) / iimage.height;
		var x2 = parseInt(div.style.width) / iimage.width + x1;
		var y2 = parseInt(div.style.height) / iimage.height + y1;
		var hotspot_coords = "" + x1 + "," + y1 + "," + x2 + "," + y2;
		// alert(cg[i].type);
		if (cg[i].type == "article")
			cg[i].text.area = hotspot_coords;
		else if (cg[i].type == "ad") 
			cg[i].figure.area = hotspot_coords;
	}
	
	// Iterate through table and store in data set


	// var myXML = '<?xml version="1.0"?><iseePageLayout><page section="1"><contentGroup type="article" titleString="U.S. takes big step to end Net oversight"><text area="0.178,0.18375,0.33199999999999996,0.6125" newParagraph="true"></text></contentGroup><contentGroup type="ad" titleString="Tag Heuer Advertisement"><figure area="0.668,0.755,0.978,0.98375" captionText="Tag Heuer Advertisement"></figure></contentGroup></page></iseePageLayout>';
	// Store data set in XML
	var myXML = '<?xml version="1.0"?>'
	myXML += json2xml(pageObject, " ");
	placeholder_xml.innerText = myXML;

	// Send XML to server
	var request = HTTP.newRequest();
	request.open("POST", SERVER + "update", false);
	request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
	request.send("docID=" + DOCUMENT_ID + "&pageIndex=" + pageIndex + "&layout=" + escape(myXML));
}

function deleteRow(row)
{	
	var cg = pageObject.iseepagelayout.page.contentgroup;
	
	cg[row] = null;
	deleteHotspot(row);
	buildTable();
}

function addRow()
{	
	var cg = pageObject.iseepagelayout.page.contentgroup;

	// Add new data row
	cg[cg.length] = 
	{
		type:'article',
        	titlestring:'Title of article',
		text:
		{
			area:'0.1,0.1,0.25,0.25', newparagraph:'true'
		}
	}

	// Store the values in the table to the data set
	saveTable();

	// Rebuild the table from the data set
	buildTable();

	// initializeHotspots();

	// Add the hotspot
	hotspot = createHotspot(cg.length - 1);

	// Position the hotspot
	hotspot.style.left = 0.1 * iimage.width + "px";
	hotspot.style.top = 0.1 * iimage.height + "px";
	hotspot.style.width = (0.25 - 0.1) * iimage.width  + "px";
	hotspot.style.height = (0.25 - 0.1) * iimage.height + "px";
}

window.onload = function()
{
	initialize();
}

function initialize()
{
	selectDocument.value = DOCUMENT_ID;
	var layoutXML = XML.load(SERVER + "layout?docID=" + DOCUMENT_ID + "&pageIndex=" + pageIndex + "&action=getLayout");
	var layoutString = XML.serialize(layoutXML);

	placeholder_xml.innerText = layoutString;
	placeholder_xml.innerHTML += "<br>" + xml2json.parser(layoutString, "", "html");

	pageObject = xml2json.parser(layoutString);

	if (pageObject == null) pageObject = {};
	if (pageObject.iseepagelayout == null) pageObject.iseepagelayout = {};
	if (pageObject.iseepagelayout.page == null) pageObject.iseepagelayout.page = {};
	if (pageObject.iseepagelayout.page.contentgroup == null) pageObject.iseepagelayout.page.contentgroup = [];

	if (pageObject.iseepagelayout.page.contentgroup.length == undefined)
	{
		var temp = pageObject.iseepagelayout.page.contentgroup;
		pageObject.iseepagelayout.page.contentgroup = new Array(temp);
	}

	buildTable();
	updateImage("large", false);

	var pageXML = XML.load(SERVER + "layout?docID=" + DOCUMENT_ID + "&action=getPageCount");
	var pageString = XML.serialize(pageXML);
	var pageCountObject = xml2json.parser(pageString);

	var thumbnailsString = "<center>";
	for (var i = 0; i < pageCountObject.pages.count; i++)
	{
		thumbnailsString += '<p><img border="1" onclick="javascript:changePage(' + i + ')" src="' + SERVER + 'docs/' + DOCUMENT_ID + '/thumbnail?page=' + i + '&wid=50&qlt=80"></p>';
	}
	thumbnails.innerHTML = thumbnailsString + "</center>";

}

function changeType(row, type)
{
}

function moveRowUp(row)
{
	var cg = pageObject.iseepagelayout.page.contentgroup;
	if (row > 0)
	{
		// Change rows in data set
		var temp = cg[row];
		cg[row] = cg[row - 1];
		cg[row-1] = temp;

		// Rename hotspot
		blurHotspot(row);
		var myDiv = document.getElementById("hotspot" + row);
		var prevDiv = document.getElementById("hotspot" + (row - 1 ) );
		prevDiv.setAttribute("id", "hotspot" + "temp");
		myDiv.setAttribute("id", "hotspot" + (row - 1));
		prevDiv.setAttribute("id", "hotspot" + row);

		buildTable();
	}
}

function moveRowDown(row)
{
	var cg = pageObject.iseepagelayout.page.contentgroup;
	if (row < cg.length - 1)
	{
		// Change rows in data set
		var temp = cg[row];
		cg[row] = cg[row + 1];
		cg[row+1] = temp;

		// Rename hotspot
		blurHotspot(row);
		var myDiv = document.getElementById("hotspot" + row);
		var nextDiv = document.getElementById("hotspot" + (row + 1) );
		nextDiv.setAttribute("id", "hotspot" + "temp");
		myDiv.setAttribute("id", "hotspot" + (row + 1));
		nextDiv.setAttribute("id", "hotspot" + row);

		buildTable();
	}
}

function focusHotspot(row)
{	
	var hs = document.getElementById("hotspot" + row);
	hs.style.backgroundColor = "yellow";
	hs.style.opacity = "0.50";
	hs.style.filter = "alpha(opacity=50)";
	hs.style.borderColor = "red";
}

function blurHotspot(row)
{	
	var hs = document.getElementById("hotspot" + row);
	hs.style.backgroundColor = "";
	hs.style.opacity = "";
	hs.style.filter = "";
	hs.style.borderColor = "blue";
}

function buildTable()
{
	var cg = pageObject.iseepagelayout.page.contentgroup;
	var tableString = '<table id="table1" border="0"><tr align="center"><td></td><td><b>Title</b></td><td><b>Type</b></td><td><b>E-mail</b></td><td><b>Phone</b></td><td><b>SMS</b></td></tr>';
	for (var i = 0; i < cg.length; i++)
	{
		// If data row was deleted then skip
		if (cg[i] == null) continue;

		tableString += '<tr>'
			+ '<td><a onblur="blurHotspot(' + i + ');" onfocus="focusHotspot(' + i + ');" href="javascript:deleteRow(' + i + ')"><img border="0" src="images/x.gif"></a>'
			+ '<a onblur="blurHotspot(' + i + ');" onfocus="focusHotspot(' + i + ');" href="javascript:moveRowUp(' + i + ')"><img border="0" src="images/up.gif"></a>'
			+ '<a onblur="blurHotspot(' + i + ');" onfocus="focusHotspot(' + i + ');" href="javascript:moveRowDown(' + i + ')"><img border="0" src="images/down.gif"></a></td>'
			+ '<td><input onblur="blurHotspot(' + i + ');" onfocus="focusHotspot(' + i + ');" id="textinput" size="30" type="text" value="' + cg[i].titlestring + '"></input></td>';
		if (cg[i].text)
		{
			tableString += '<td><select onblur="blurHotspot(' + i + ');" onfocus="focusHotspot(' + i + ');" onchange="changeType('+ i + ', this.value);"><option value="ad">Ad<option value="article" SELECTED>Article</select></td>'
			// tableString += "<td>" + cg[i].text.area + "</td>"
		}
		else
		{
			tableString += '<td><select onblur="blurHotspot(' + i + ');" onfocus="focusHotspot(' + i + ');" onchange="changeType('+ i + ', this.value);"><option value="ad" SELECTED>Ad<option value="article">Article</select></td>'
			// tableString += "<td>" + cg[i].figure.area + "</td>"
		}
		var email = "";
		if(typeof(cg[i].email) == "string" && cg[i].email != undefined) email = cg[i].email;
		var phone = "";
		if(typeof(cg[i].phone) == "string" && cg[i].phone != undefined) phone = cg[i].phone;
		var sms = "";
		if(typeof(cg[i].sms) == "string" && cg[i].sms != undefined) sms = cg[i].sms;

		tableString += '<td><input onblur="blurHotspot(' + i + ');" onfocus="focusHotspot(' + i + ');" id="textinput" size="20" type="text" value="' + email + '"></input></td>';
		tableString += '<td><input onblur="blurHotspot(' + i + ');" onfocus="focusHotspot(' + i + ');" id="textinput" size="10" type="text" value="' + phone + '"></input></td>';
		tableString += '<td><input onblur="blurHotspot(' + i + ');" onfocus="focusHotspot(' + i + ');" id="textinput" size="3" type="text" value="' + sms + '"></input></td>';
		tableString += "</tr>";
	}
	tableString += '</table><table border="0"><tr ><td><a href="javascript:addRow();"><img border="0" src="images/add.gif"></a></td></tr></table>';
	placeholder_data.innerHTML = tableString;
	if (cg.length == 0) addRow();
}

window.onunload = function()
{
	var message = "" +
		"You have made changes to the publication:\n" +
		"Your changes have not been not saved.\n" +
		"        ______________________________\n\n" +
		"Click \"OK\" to save or \"Cancel\" to cancel changes.\n";
	// Save data before exiting
	// if(confirm(message)) submit();
};

function $(x)
{
	if (typeof x == "string") return document.getElementById(x);
	return x;
}

// var headline = document.getElementById("headline");
// headline.setAttribute("align", "center"); // Set align="center"

function updateImage(size, isUpdate)
{
	isUpdate = true;
	var wid = 300;
	switch(size)
	{
		case "small":
			wid = 300;
			break;
		case "medium":
			wid = 450;
			break;
		case "large":
			wid = 600;
			break;
		default:
			wid = 300;
			break;
	}
	// var a1 = $("a1");
	
	iimage.onload = afterImageLoaded;
	iimage.src = SERVER + "docs/" + DOCUMENT_ID + "/thumbnail?page=" + pageIndex + "&wid=" + wid + "&qlt=80";
	if (isUpdate)
	{

		a1.x1 = parseInt(a1.style.left) / iimage.width;
		a1.y1 = parseInt(a1.style.top) / iimage.height;
		a1.x2 = parseInt(a1.style.width) / iimage.width + a1.x1;
		a1.y2 = parseInt(a1.style.height) / iimage.height + a1.y1;
		// a1.style.visibility = "hidden";
	}
}

function afterImageLoaded()
{
	initializeHotspots();
	dragresize.maxLeft = iimage.width;
	dragresize.maxTop = iimage.height;
}

function createHotspot(id)
{
	var div = document.createElement("div");

	div.setAttribute("id", "hotspot" + id);
	div.className = "drsElementAlt drsMoveHandleAlt";
	div.style.position = "absolute";
	div.style.left = 0;
	div.style.top = 0;
       	div.style.width = 300;
       	div.style.height = 300;
       	div.style.zOrder="+2";
	// Show name of hotspot
	// div.innerHTML = "<b>" + div.getAttribute("id") + "</b>";
	canvas.appendChild(div);
	return div;
}

function deleteHotspot(hotspot)
{
	var c = document.getElementById("canvas");
	var d = document.getElementById("hotspot" + hotspot);
	c.removeChild(d);
}

function deleteHotspots()
{
	var cg = pageObject.iseepagelayout.page.contentgroup;

	for (var i = 0; i < cg.length; i++)
	{
		if (cg[i] == null) continue;
		deleteHotspot(i);
	}
}

function initializeHotspots()
{
	var cg = pageObject.iseepagelayout.page.contentgroup;

	for (var i = 0; i < cg.length; i++)
	{
		if (cg[i] == null) continue;

		var coords = "";

		if (cg[i].text) 
			coords = cg[i].text.area;
		else if (cg[i].figure) 
			coords = cg[i].figure.area;
		var point = coords.split(",");

		var hotspot = document.getElementById("hotspot" + i);
		// If hotspots doesn't exist then create new one.
		if (hotspot == null)
		{
			hotspot = createHotspot(i);
		}
		hotspot.style.left = point[0] * iimage.width + "px";
		hotspot.style.top = point[1] * iimage.height + "px";
		hotspot.style.width = (point[2] - point[0]) * iimage.width  + "px";
		hotspot.style.height = (point[3] - point[1]) * iimage.height + "px";
	}
	/*
	a1.style.left = a1.x1 * iimage.width + "px";
	a1.style.top = a1.y1 * iimage.height + "px";
	a1.style.width = (a1.x2 - a1.x1) * iimage.width  + "px";
	a1.style.height = (a1.y2 - a1.y1) * iimage.height + "px";
	a1.style.visibility = "visible";
	*/
}

function changeView()
{
	if ("255px" == thumbnails.style.top)
	{
		thumbnails.style.top = "95px";
		canvas.style.top = "95px";
		placeholder_data.style.left = "710px";
		placeholder_data.style.width = "250px";
		placeholder_data.style.height = "400px";
	}
	else
	{
		thumbnails.style.top = "255px";
		canvas.style.top = "255px";
		placeholder_data.style.left = "10px";
		placeholder_data.style.width = "690px";
		placeholder_data.style.height = "150px";
	}
}
</script>

<style type="text/css">

#image
{
  left: 0px;
  top: 0px;
  overflow: auto;             /* Give us scrollbars if we need them */
  border: 1px solid #000000; border-style: solid;
}

div.pages
{  /* Specifies size, position and scrolling for window content */
    position: absolute;         /* It's a positioned element */
    left: 10px;
    top: 255px;                  /* 18px title+2px border+3px+2px padding */
    width: 75px;               /* 300px width - 10px of padding */
    height: 400px;              /* 200px total - 25px titlebar - 10px padding*/
    padding: 5px;               /* Allow space on all four sides */
    overflow: auto;             /* Give us scrollbars if we need them */
    border: 1px solid #333;
}

.drsElement {
 position: absolute;
 border: 1px solid #333;
}

.drsElementAlt {
 position: absolute;
 border: 2px solid #0000ff;
 background-image: url('images/spacer.gif'); border-style: dotted; color: #0000ff;
}


.drsMoveHandle {
 height: 20px;
 background-color: #CCC;
 border-bottom: 1px solid #666;
 cursor: move;
}

.drsMoveHandleAlt {
 height: 20px;
 border-bottom: 2px solid #0000ff;
 cursor: move;
 background-image: url('images/spacer.gif'); border-style: dotted; color: #0000ff;
}

.dragresize {
 position: absolute;
 width: 5px;
 height: 5px;
 font-size: 1px;
 background: #0000cc;
 border: 0px solid #0000ff;
}

.dragresize-tl {
 top: -8px;
 left: -8px;
 cursor: nw-resize;
}
.dragresize-tm {
 top: -8px;
 left: 50%;
 margin-left: -4px;
 cursor: n-resize;
}
.dragresize-tr {
 top: -8px;
 right: -8px;
 cursor: ne-resize;
}

.dragresize-ml {
 top: 50%;
 margin-top: -4px;
 left: -8px;
 cursor: w-resize;
}
.dragresize-mr {
 top: 50%;
 margin-top: -4px;
 right: -8px;
 cursor: e-resize;
}

.dragresize-bl {
 bottom: -8px;
 left: -8px;
 cursor: sw-resize;
}
.dragresize-bm {
 bottom: -8px;
 left: 50%;
 margin-left: -4px;
 cursor: s-resize;
}
.dragresize-br {
 bottom: -8px;
 right: -8px;
 cursor: se-resize;
}

</style>

<script type="text/javascript">
//<![CDATA[

// Using DragResize is simple!
// You first declare a new DragResize() object, passing its own name and an object
// whose keys constitute optional parameters/settings:

var dragresize = new DragResize('dragresize',
 { minWidth: 20, minHeight: 20, minLeft: 0, minTop: 0, maxLeft: 600, maxTop: 960 });

dragresize.isElement = function(elm)
{
 if (elm.className && elm.className.indexOf('drsElement') > -1) return true;
};
dragresize.isHandle = function(elm)
{
 if (elm.className && elm.className.indexOf('drsMoveHandle') > -1) return true;
};


dragresize.ondragfocus = function() { };
dragresize.ondragstart = function(isResize) { };
dragresize.ondragmove = function(isResize) { 
};
dragresize.ondragend = function(isResize) { };
dragresize.ondragblur = function() { };

// Finally, you must apply() your DragResize object to a DOM node; all children of this
// node will then be made draggable. Here, I'm applying to the entire document.
dragresize.apply(document);

//]]>
</script>

</head>
<body style="background-color: #67999A; margin:0px; padding: 0px; font: 13px/20px sans-serif;">
<table width="100%" bgcolor="#223A54" border=0 cellpadding=0 cellspacing=2><tr><td><img src="images/logo.gif"></td><td valign="middle"><h2 id="headline"><font color="red"><br>iseepublish TEST - Internal Use Only</font></h2></td></tr></table>

<div id="canvas" style="position: absolute; left: 100px; top: 255px; border: 1px solid">

<divi id="a1" class="drsElementAlt drsMoveHandleAlt"
 style="left: 210px; top: 170px; width: 80px; height: 300px;
  background-image: url('images/spacer.gif'); border-style: dotted; color: #0000ff;
  text-align: left; font-weight: bold; z-order:+2;">
<!-- &nbsp;<img src="images/image.gif">&nbsp;1 -->
</divi>

<div id="image">
<img id="iimage" src="images/image.gif"></img>
</div>

</div>

<div id="thumbnails" style="top: 255px" class="pages">
</div>

<divi id="articles" style="border: 1px solid #333; position: absolute; width:400px; height:75px; left: 100px; top: 40px; overflow: auto;">
</divi>

<div id="articles" style="border: 0px solid #333; position: absolute; left: 10px; top: 65px; overflow: auto;">
<a href="javascript:submit();"><img border="0" src="images/save.gif"></a>&nbsp;<a href="javascript:changeView();"><img border="0" src="images/view.gif"></a>&nbsp;
<select id="selectDocument" onchange="changeDocument(this.value);">
<option value="businessweek_test" SELECTED>Business Week TEST - 4 pages
<option value="iht_test">Internation Herald Tribune TEST - 22 pages
<option value="ihtOnePage">ihtOnePage - 1 page
<option value="ihtOnePage2">ihtOnePage2 - 1 page
<option value="thehindu">The Hindu - 1 page
</select>

<!-- Image Size:&nbsp;<select onchange="javascript:updateImage(this.value, true);" name="size"><option value="small">Small<option value="medium">Medium<option value="large" SELECTED>Large</select> -->
</div>

<div id="placeholder_data" style="border: 1px solid #333; position: absolute; width:690px; height:150px; left: 10px; top: 95px; overflow: auto;"></div>
<div style="margin-top: 400px"><!-- spacer --></div>
<div id="placeholder_xml" style="visibility: hidden; border: 1px solid #333; position: absolute; width:300px; height:600px; left: 710px; top: 95px; overflow: auto;"></div>

</body>
</html>